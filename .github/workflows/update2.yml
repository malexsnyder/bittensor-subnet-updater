name: Bittensor Subnet Updater (update2)

on:
  schedule:
    - cron: "0 * * * *"  # Runs every hour
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip uninstall -y openai || true
          pip install --upgrade "openai>=1.40.0"
          pip install requests pandas bittensor faiss-cpu
          python -m pip show openai

      - name: Fetch latest Bittensor subnet data
        env:
          OPENAI_API_KEY: ${{ secrets.BITTENSOR_SUBNETS }}
        run: |
          python scripts/fetch_subnets_bt.py

      - name: Build subnet profiles
        run: |
          python scripts/build_profiles_local.py

      - name: Combine profiles into a single file
        run: |
          cat data/profiles/*.md > data/all_subnet_profiles.txt
          echo "📊 Combined profiles file size: $(wc -c < data/all_subnet_profiles.txt) bytes"
          echo "📄 First 200 characters:"
          head -c 200 data/all_subnet_profiles.txt

      - name: Upload latest subnet data to OpenAI Vector Store
        env:
          OPENAI_API_KEY: ${{ secrets.BITTENSOR_SUBNETS }}
        run: |
          python - <<'EOF'
          import os
          import sys
          import time
          
          print("🔍 OpenAI SDK version check:")
          try:
              import openai
              print(f"OpenAI version: {getattr(openai, '__version__', 'unknown')}")
          except Exception as e:
              print(f"❌ Error importing openai: {e}")
              sys.exit(1)

          try:
              from openai import OpenAI
              print("✅ Using new OpenAI client interface")
          except ImportError as e:
              print(f"❌ The new OpenAI client is not available: {e}")
              sys.exit(1)

          # Check API key
          api_key = os.environ.get("OPENAI_API_KEY")
          if not api_key:
              print("❌ OPENAI_API_KEY environment variable not set")
              sys.exit(1)
              
          if not api_key.startswith("sk-"):
              print("❌ OPENAI_API_KEY does not appear to be valid (should start with 'sk-')")
              sys.exit(1)
              
          print("✅ API key format looks correct")

          client = OpenAI(api_key=api_key)

          vector_store_id = "vs_68f441099ff88191a84e2e4dadfdc104"
          profiles_path = "data/all_subnet_profiles.txt"

          if not os.path.exists(profiles_path):
              print(f"❌ {profiles_path} not found.")
              sys.exit(1)
              
          file_size = os.path.getsize(profiles_path)
          print(f"📄 File size: {file_size} bytes")

          # Test vector store access first
          try:
              print("🔍 Testing vector store access...")
              vector_store = client.vector_stores.retrieve(vector_store_id)
              print(f"✅ Vector store found: {vector_store.name}")
          except Exception as e:
              print(f"❌ Error accessing vector store: {e}")
              print("💡 Make sure the vector store ID is correct and you have access to it")
              sys.exit(1)

          print("📤 Uploading subnet data to vector store...")

          try:
              # Use the correct API method for file upload
              with open(profiles_path, "rb") as f:
                  # First upload the file
                  file_response = client.files.create(
                      file=f,
                      purpose="assistants"
                  )
                  print(f"📁 File uploaded with ID: {file_response.id}")
                  
                  # Then add it to the vector store
                  vector_store_file = client.vector_stores.files.create(
                      vector_store_id=vector_store_id,
                      file_id=file_response.id
                  )
                  print(f"✅ File added to vector store successfully.")
                  print(f"📁 Vector store file ID: {vector_store_file.id}")
                  
          except Exception as e:
              print(f"❌ Error uploading file: {e}")
              print("💡 Common issues:")
              print("   - Vector store ID is incorrect")
              print("   - File is too large")
              print("   - API key doesn't have access to the vector store")
              print("   - Vector store is full")
              print(f"   - Error details: {str(e)}")
              sys.exit(1)
          EOF

      - name: Commit and push updates
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase origin main || true
          git add -A
          git commit -m "Auto-update $(date -u '+%Y-%m-%dT%H:%M:%SZ')" || echo "No changes"
          git push origin main || echo "Push failed"

# 